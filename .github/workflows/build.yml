name: PLC110_GKI_Extreme_Search
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘4åˆ†é’Ÿå®Œæˆåº•åº§æ‹‰å–
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # åŠ¨æ€é€’å½’å®šä½å†…æ ¸ Makefile æ‰€åœ¨åœ°
          echo "REAL_KERNEL_DIR=$(find $(pwd) -name "Makefile" | xargs grep -l "VERSION = 6" | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. ã€å…¨åŸŸ GKI æœå¯»ã€‘è·¨ä»“åº“å¯»æ‰¾æ··åˆé’©å­
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          rm -rf drivers/kernelsu
          
          # åŒ…å«é…·å®‰ã€GKI å¼€å‘è€…å¸¸ç”¨çš„æ··åˆé’©å­ä»“åº“
          GKI_REPOS=(
            "https://github.com/rifsxd/KernelSU-Next"
            "https://github.com/WildKernels/KernelSU"
            "https://github.com/tiann/KernelSU"
            "https://github.com/idsc-dev/KernelSU"
            "https://github.com/DizzyThermal/KernelSU"
            "https://github.com/bmax-dev/KernelSU"
          )

          FOUND=false
          for repo in "${GKI_REPOS[@]}"; do
            echo "ğŸŒ æ¢æµ‹ GKI ä»“åº“: $repo"
            # å°è¯•æ¢æµ‹ next, main, master, gki ä¸‰ä¸ªå¸¸ç”¨åˆ†æ”¯
            for branch in next main master gki; do
              # å…³é”®ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æ··åˆé’©å­ç‰¹æœ‰çš„å®å®šä¹‰
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -E "HYBRID_HOOK|CONFIG_KSU_NEXT"; then
                echo "ğŸ¯ åŒ¹é…æˆåŠŸï¼ä»“åº“: $repo åˆ†æ”¯: $branch"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu
                FOUND=true && break 2
              fi
            done
          done

      - name: 4. ã€ä¿®å¤è·¯å¾„ã€‘æ³¨å…¥ ADIOS ä¸ BBG
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || git clone --depth=1 https://github.com/firelzrd/adios drivers/adios
          
          # æš´åŠ›æœå¯» Kconfig ä½ç½®ï¼Œè§£å†³ 1000022702 æŠ¥é”™
          # ä¸å†å‡è®¾å®ƒåœ¨ kernel/schedï¼Œè€Œæ˜¯å…¨ç›®å½•æœç´¢
          KCONFIG_PATH=$(find . -path "*/sched/Kconfig" | head -n 1)
          MAKEFILE_PATH=$(find . -path "*/sched/Makefile" | head -n 1)
          
          # ç¡®å®š ADIOS æºç è·¯å¾„
          ADIOS_DIR=$(find . -name "adios" -type d | head -n 1)
          
          echo "obj-y += $(basename $ADIOS_DIR)/" >> "$MAKEFILE_PATH"
          sed -i "/endmenu/i source \"$ADIOS_DIR/Kconfig\"" "$KCONFIG_PATH"
          
          # 6.6 å†…æ ¸å¤´æ–‡ä»¶å…¼å®¹æ€§è‡ªåŠ¨ä¿®å¤
          find . -name "adios" -type d -exec sh -c 'find {} -name "*.[ch]" | xargs sed -i "s/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g"' \;
          
          # æ³¨å…¥ BBG
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 5. å¼€å¯ cctv æè‡´ä¼˜åŒ–å®
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          # æŸ¥æ‰¾æ­£ç¡®çš„ defconfig
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
          } >> "$DEF"

      - name: 6. ç¼–è¯‘ä¸æ‰“åŒ…
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          make O=out ARCH=arm64 $(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig"))
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)
          
          # æ‰“åŒ…
          git clone https://github.com/osm0sis/AnyKernel3
          cp $(find out/ -name Image) AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_GKI_Extreme.zip *

      - name: 7. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-GKI-Extreme
          path: "*.zip"
