name: PLC110_Ultimate_V17_Fengchi
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒåŠ å›ºä¸æ¸…ç†
        run: |
          sudo apt update && sudo apt install repo curl git python3 patch zip -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘ä¸€åŠ  6.6 æ ¸å¿ƒåº•åº§
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. ã€å…¨åŸŸå¹¿åŸŸæœå¯»ã€‘å¯»æ‰¾æœ€å¼ºæ··åˆé’©å­
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          
          # æå¤§åŒ–æœç´¢åå•ï¼ŒåŒ…å« GKI ç¤¾åŒºæ‰€æœ‰æ´»è·ƒæº
          SOURCES=(
            "https://github.com/simonpunk/KernelSU"
            "https://github.com/rifsxd/KernelSU-Next"
            "https://github.com/WildKernels/KernelSU"
            "https://github.com/tiann/KernelSU"
            "https://github.com/idsc-dev/KernelSU"
            "https://github.com/DizzyThermal/KernelSU"
          )

          FOUND=false
          for repo in "${SOURCES[@]}"; do
            echo "ğŸŒ æ·±åº¦æ¢æµ‹: $repo"
            for branch in next hybrid-next main master gki-android14-6.6; do
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -qE "HYBRID_HOOK|CONFIG_KSU_NEXT"; then
                echo "ğŸ¯ åŒ¹é…æˆåŠŸï¼æº: $repo åˆ†æ”¯: $branch"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu && FOUND=true && break 2
              fi
            done
          done

          if [ "$FOUND" = false ]; then
            echo "âš ï¸ å…¨åŸŸæœªå‘ç°åŸç”Ÿåˆ†æ”¯ï¼Œå¯åŠ¨ Tarball æš´åŠ›è¡¥ä¸..."
            curl -LO https://github.com/rifsxd/KernelSU-Next/archive/refs/heads/next.tar.gz || curl -LO https://github.com/rifsxd/KernelSU-Next/archive/refs/heads/main.tar.gz
            mkdir -p drivers/kernelsu && tar -xzf *.tar.gz -C drivers/kernelsu --strip-components=1
            sed -i '/config KSU_NEXT$/a \    bool "Enable Hybrid Hook"\n    default y' drivers/kernelsu/ksu/Kconfig
            find drivers/kernelsu/ -name "*.c" | xargs sed -i 's/ifndef CONFIG_KSU_NEXT_HYBRID_HOOK/if 1 \/\/ Forced/g'
          fi

      - name: 4. ã€æ ¸å¿ƒæ³¨å…¥ã€‘cctv é£é©° (Fengchi) æ¸¸æˆå†…æ ¸è¡¥ä¸
        run: |
          cd ${{ env.K_ROOT }}
          echo "ğŸš€ æ­£åœ¨æ‹‰å– cctv å¤§ä½¬çš„é£é©°æ¸¸æˆä¼˜åŒ–è¡¥ä¸..."
          # ç…§æ¬ cctv å¤§ä½¬çš„ patch è·¯å¾„
          curl -LO https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          
          # å°è¯•åº”ç”¨è¡¥ä¸ï¼Œå¦‚æœéƒ¨åˆ†å†²çªåˆ™å¼ºåˆ¶åˆå…¥å¹¶è®°å½•
          patch -p1 < fengchi.patch || echo "âš ï¸ è¡¥ä¸å­˜åœ¨éƒ¨åˆ†å†²çªï¼Œå·²è·³è¿‡å†²çªéƒ¨åˆ†"

      - name: 5. ã€æ‹†åˆ†æ¨¡å—ã€‘æ³¨å…¥ ADIOS ä¸ BBG
        continue-on-error: true
        run: |
          cd ${{ env.K_ROOT }}
          # æ³¨å…¥ ADIOS
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          TK=$(find . -name "Kconfig" -path "*/sched/*" | head -n 1)
          TM=$(find . -name "Makefile" -path "*/sched/*" | head -n 1)
          if [ -n "$TK" ]; then
             echo 'obj-y += adios/' >> "$TM"
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TK"
             find kernel/sched/adios/ -type f -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g' || true
          fi
          # æ³¨å…¥ BBG
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 6. ã€ç‰©ç†é”å®šã€‘å¼€å¯æè‡´æ€§èƒ½å®
        run: |
          cd ${{ env.K_ROOT }}
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          {
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            # å¼ºåŒ– sugov_ext è°ƒåº¦
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
            echo "CONFIG_MTK_SCHED_BOOST=y"
          } >> "$DEF"

      - name: 7. æ‰§è¡Œç¼–è¯‘ (LTO æ€§èƒ½ä¼˜åŒ–)
        run: |
          cd ${{ env.K_ROOT }}
          C_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$C_NAME"
          # ä½¿ç”¨ LLVM å¼€å¯ç¼–è¯‘
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. æ‰“åŒ…å‘å¸ƒ
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_Fengchi_V17.zip *

      - name: 9. ä¸Šä¼ äº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-Fengchi-Kernel
          path: "*.zip"
