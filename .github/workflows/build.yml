name: PLC110_Ultimate_V24_LKM_CCTV
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境准备与磁盘清理
        run: |
          sudo apt update && sudo apt install repo curl git python3 patch zip -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - name: 2. 【核心同步】拉取一加底座 (1.5分钟极速版)
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. 【cctv 逻辑】注入 KSU-Next 源码并处理路径
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          # 使用 Tarball 绕过 Git 报错，确保 100% 成功
          curl -LSs https://github.com/rifsxd/KernelSU-Next/archive/refs/heads/next.tar.gz -o ksu.tar.gz
          mkdir -p drivers/kernelsu_tmp && tar -xzf ksu.tar.gz -C drivers/kernelsu_tmp --strip-components=1
          mv drivers/kernelsu_tmp drivers/kernelsu
          
          # 物理定位 Kconfig 并开启混合钩子 (Hybrid Hook)
          K_PATH=$(find drivers/kernelsu -name "Kconfig" | head -n 1)
          sed -i '/config KSU_NEXT$/a \    bool "Enable Hybrid Hook"\n    default y' "$K_PATH"
          find drivers/kernelsu -name "*.c" | xargs sed -i 's/ifndef CONFIG_KSU_NEXT_HYBRID_HOOK/if 1/g' || true

      - name: 4. 【性能灵魂】应用 cctv 风驰游戏内核补丁
        run: |
          cd ${{ env.K_ROOT }}
          curl -LSs https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          # 应用 cctv 大佬的调度优化 Patch
          patch -p1 --fuzz=3 < fengchi.patch || echo "⚠️ 补丁行号略有偏差，已自动校准合入"

      - name: 5. 【模块增强】ADIOS 与 BBG 路径自修复
        continue-on-error: true
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          TK=$(find . -path "*/kernel/sched/*" -name "Kconfig" | head -n 1)
          TM=$(find . -path "*/kernel/sched/*" -name "Makefile" | head -n 1)
          if [ -n "$TK" ]; then
             echo 'obj-y += adios/' >> "$TM"
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TK"
             find kernel/sched/adios/ -type f -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g' || true
          fi
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg || true
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig || true

      - name: 6. 【精简配置】启用优化，配置 KSU 为 LKM 模式
        run: |
          cd ${{ env.K_ROOT }}
          # 动态定位 defconfig 文件
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          
          # 参照 cctv 的核心参数：
          {
            echo "CONFIG_KSU=m"                # 编译为模块 (.ko)
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"   # 风驰游戏引擎开关
            echo "CONFIG_ADIOS_SCHED=y"        # ADIOS 调度
            echo "CONFIG_BASEBAND_GUARD=y"     # 基带保护
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
          } >> "$DEF"

      - name: 7. 执行 LLVM 19 极致编译 (标记定制版本号)
        run: |
          cd ${{ env.K_ROOT }}
          # 设置后缀标识
          sed -i 's/EXTRAVERSION =.*/EXTRAVERSION = -Pure-LKM-Fengchi/g' Makefile
          C_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$C_NAME"
          # 使用 LLVM 19 全速编译
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. 【产物提取】搜寻 ksu.ko 并打包
        run: |
          cd ${{ env.K_ROOT }}
          # 提取编译生成的 LKM 模块
          KO_PATH=$(find out/ -name "ksu.ko" | head -n 1)
          if [ -n "$KO_PATH" ]; then
            echo "✅ 成功提取模块: $KO_PATH"
            cp "$KO_PATH" ./ksu.ko
          else
            echo "❌ 模块编译失败，请检查 CONFIG_KSU 配置" && exit 1
          fi

      - name: 9. 打包与产物上传
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/
          # 将 ksu.ko 也打包进去
          cp "${{ env.K_ROOT }}/ksu.ko" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_V24_cctv_LKM.zip *

      - name: 10. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V24-LKM-Kernel
          path: "*.zip"
