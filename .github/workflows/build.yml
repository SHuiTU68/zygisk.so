name: Build-PLC110-Final
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Maximize Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git libelf-dev libssl-dev lz4 liblz4-tool python3-pip zip tar curl sed uuid-dev wget pahole

      - name: Sync Source and KSUN
        run: |
          # 动态匹配分支，解决 exit code 128
          git clone --depth=1 https://github.com/OnePlusOSS/android_kernel_oneplus_mt6991 kernel_src
          
          # 拉取 Clang r522830
          mkdir clang
          curl -LSs https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522830.tar.gz | tar -xzC clang
          
          # 集成 Pershoot 的 KernelSU Next (Hybrid Hook)
          cd kernel_src
          curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/main/kernel/setup.sh" | bash -s main

      - name: Optimization and Patching
        run: |
          cd kernel_src
          # 强制性能优化
          sed -i 's/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y/g' arch/arm64/configs/gki_defconfig
          sed -i 's/-Os/-O2/g' Makefile
          
          # 禁用 Kprobes 以启用混合钩子逻辑
          echo "CONFIG_KPROBES=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPROBE_EVENTS=n" >> arch/arm64/configs/gki_defconfig

      - name: Build
        run: |
          cd kernel_src
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: Package AK3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 AK3
          cd AK3
          rm -rf .git README.md
          
          # 写入完全匹配你截图的刷写脚本逻辑
          cat <<EOF > anykernel.sh
### AnyKernel3 Ramdisk Mod Script
properties() { '
kernel.string=KSUN-PLC110-Hybrid
do.devicecheck=0
do.modules=0
do.systemless=0
do.cleanup=1
device.name1=PLC110
supported.versions=14, 15
'; }

block=boot;
is_slot_device=auto;
ramdisk_compression=auto;
patch_vbmeta_flag=auto;
no_magisk_check=1;

. tools/ak3-core.sh;

# 6.6 内核检测逻辑
kernel_version=\$(cat /proc/version | awk -F '-' '{print \$1}' | awk '{print \$3}')
case \$kernel_version in
  5.1*) ksu_supported=true ;;
  6.1*) ksu_supported=true ;;
  6.6*) ksu_supported=true ;;
  *) ksu_supported=false ;;
esac

ui_print " " "-> Wild Kernels Supported: \$ksu_supported"
\$ksu_supported || abort " -> Non-GKI device, abort."

split_boot;
if [ -f "split_img/ramdisk.cpio" ]; then
  unpack_ramdisk;
  write_boot;
else
  flash_boot;
fi
EOF

          # 提取 Image
          cp ../kernel_src/out/arch/arm64/boot/Image ./Image
          zip -r ../KSUN-PLC110-Full.zip *

      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: KSUN-PLC110-Final
          path: "*.zip"
