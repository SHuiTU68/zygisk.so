name: PLC110_Ultimate_V15_Full
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境加固
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. 【极速同步】一加 6.6 核心底座
        run: |
          mkdir -p workspace && cd workspace
          # 核心极速逻辑
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # 动态定位根目录
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. 【二段搜寻】混合钩子与自适应暴力补丁
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          G_LIST=("https://github.com/simonpunk/KernelSU" "https://github.com/rifsxd/KernelSU-Next")
          FOUND=false
          for repo in "${G_LIST[@]}"; do
            for branch in next hybrid-next main; do
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -q "HYBRID_HOOK"; then
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu && FOUND=true && break 2
              fi
            done
          done
          if [ "$FOUND" = false ]; then
            # 解决 1000022712 报错：多分支尝试
            REPO="https://github.com/rifsxd/KernelSU-Next"
            for b in next main master; do
              git clone -b "$b" --depth=1 "$REPO" drivers/kernelsu && B_OK=true && break
            done
            # 暴力补丁织入
            sed -i '/config KSU_NEXT$/a \    bool "Enable Hybrid Hook"\n    default y' drivers/kernelsu/ksu/Kconfig
            find drivers/kernelsu/ -name "*.c" | xargs sed -i 's/ifndef CONFIG_KSU_NEXT_HYBRID_HOOK/if 1 \/\/ Forced/g'
          fi

      - name: 4. 【独立模块】注入 ADIOS 调度器
        continue-on-error: true # 解决 1000022711 路径报错
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          TK=$(find . -name "Kconfig" -path "*/sched/*" | head -n 1)
          TM=$(find . -name "Makefile" -path "*/sched/*" | head -n 1)
          if [ -n "$TK" ]; then
             echo 'obj-y += adios/' >> "$TM"
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TK"
             find kernel/sched/adios/ -type f -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'
          fi

      - name: 5. 【独立模块】注入 BBG 基带保护
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 6. 【物理锁定】开启 oplus 特有宏配置
        run: |
          cd ${{ env.K_ROOT }}
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
          } >> "$DEF"

      - name: 7. 执行编译 (LLVM 19)
        run: |
          cd ${{ env.K_ROOT }}
          # 这里的配置文件名需要物理动态提取
          C_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$C_NAME"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. 打包发布
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_GKI_V15.zip *

      - name: 9. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V15-Kernel
          path: "*.zip"
