name: Build OP-MTK6991-Hybrid-O2
on:
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    strategy:
      matrix:
        # 定义两种方案：方案一(禁用Kprobes), 方案二(修改源码)
        hook_type: [disable_kprobes, modify_source]
    runs-on: ubuntu-latest
    steps:
      # 1. 环境准备：安装编译内核所需的必要库和工具
      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison bzip2 git libelf-dev libssl-dev lz4 liblz4-tool libncurses-dev python3-pip zip tar curl sed uuid-dev wget pahole
          # 升级 cmake 以确保兼容性
          sudo pip3 install cmake
          echo "Environment Ready."

      # 2. 释放磁盘空间 (MTK源码+编译产物非常大)
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'

      # 3. 拉取源码与工具链 (仿照 cctv18 逻辑)
      - name: Sync Source and Toolchain
        run: |
          # 拉取 OnePlusOSS MTK6991 源码
          git clone --depth=1 https://github.com/OnePlusOSS/android_kernel_5.10_oneplus_mt6983 -b oneplus/mtk6991 kernel_src
          
          # 拉取最新 AOSP Clang (r522830 或更高，支持 O2 深度优化)
          mkdir clang
          cd clang
          curl -LO https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522830.tar.gz
          tar -xf *.tar.gz
          cd ..
          
          # 集成 KernelSU Next (KSUN)
          cd kernel_src
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/main/kernel/setup.sh" | bash -s main

      # 4. 极致优化与补丁注入 (LZ4 v1.10.0 + O2 + 风驰 + 混合钩子)
      - name: Advanced Optimization & Patching
        run: |
          cd kernel_src
          
          # A. 部署 LZ4 1.10.0
          git clone https://github.com/lz4/lz4.git -b v1.10.0 lz4_tool
          cd lz4_tool && make -j$(nproc) && sudo make install && cd ..
          
          # B. 注入风驰游戏补丁
          curl -LO https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          patch -p1 < fengchi.patch || echo "Patch skip some lines"

          # C. 强制 O2 优化
          sed -i 's/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y/g' arch/arm64/configs/gki_defconfig
          sed -i 's/-Os/-O2/g' Makefile

          # D. 混合钩子实现 (按照截图逻辑) & 移除 SUSFS
          find . -name "*susfs*" -exec rm -rf {} +
          if [ "${{ matrix.hook_type }}" == "disable_kprobes" ]; then
             echo "CONFIG_KPROBES=n" >> arch/arm64/configs/gki_defconfig
          else
             # 方案二：源码级硬改
             sed -i '/CONFIG_KPROBES/d' kernel/Kbuild
             sed -i '/IS_ENABLED(CONFIG_KPROBES)/d' kernel/supercalls.c
          fi

      # 5. 开始构建 (仿照 cctv18 的编译指令)
      - name: Start Build
        run: |
          cd kernel_src
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          # 这里填入具体的编译命令，例如：
          # make O=out ARCH=arm64 gki_defconfig
          # make O=out ARCH=arm64 CC=clang LLVM=1 -j$(nproc)
          
      # 6. 打包 AnyKernel3 并上传
      - name: Package AK3
        run: |
          # 判定名称
          if [ "${{ matrix.hook_type }}" == "disable_kprobes" ]; then
            NAME="OP-MT6991-O2-NoKprobe"
          else
            NAME="OP-MT6991-O2-Hybrid-SourceMod"
          fi
          # 执行打包逻辑并上传 Artifact
