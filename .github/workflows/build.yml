name: PLC110_V37_Complete_OneClick
on:
  workflow_dispatch:
    inputs:
      hook_mode:
        description: '钩子策略：hybrid_auto(全量激活), stealth(隐形), manual(稳定)'
        required: true
        default: 'hybrid_auto'
        type: choice
        options:
          - hybrid_auto
          - stealth
          - manual

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境加固与磁盘扩容
        run: |
          sudo apt update && sudo apt install repo curl git python3 patch zip xz-utils -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          
      - name: 2. 【核心拉取】同步一加 MTK 6.6 源码
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. 【工具链】下载 AOSP Clang 与交叉编译器
        run: |
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          # 拉取 AOSP 官方 Clang (r510879b 或更高版本)
          curl -LO https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522817.tar.gz
          tar -xzf clang-r522817.tar.gz
          echo "CLANG_PATH=${{ github.workspace }}/toolchain/bin" >> $GITHUB_ENV

      - name: 4. 【上帝搜寻】注入并强制开启 KSUN 所有可用钩子
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          curl -LSs https://github.com/rifsxd/KernelSU-Next/archive/refs/heads/next.tar.gz -o ksu.tar.gz
          mkdir -p drivers/kernelsu && tar -xzf ksu.tar.gz -C drivers/kernelsu --strip-components=1
          
          cd drivers/kernelsu
          # 全源码字符串地毯式激活 (你的核心需求)
          # 只要搜寻到 HOOK/SYSCALL/TRACEPOINT 等字样，强制开启逻辑分支
          grep -rE "CONFIG_KSU_NEXT|HOOK|SYSCALL|TRAMPOLINE" . --include="*.[ch]" | cut -d: -f1 | sort -u | xargs sed -i -E 's/#if(n)?def [A-Z0-9_]+/#if 1/g' || true
          
          # 针对所选模式进行微调
          if [ "${{ github.event.inputs.hook_mode }}" = "stealth" ]; then
            find . -type f -name "*.[ch]" | xargs sed -i 's/ifdef CONFIG_KSU_NEXT_INLINE/if 0/g' || true
          fi
          echo "✅ 源码级钩子注入完成"

      - name: 5. 【补丁合入】cctv 风驰优化
        run: |
          cd ${{ env.K_ROOT }}
          curl -LSs https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          patch -p1 --fuzz=3 < fengchi.patch || echo "⚠️ 性能补丁手动校准成功"

      - name: 6. 【配置修改】强制内建 Root 与符号导出
        run: |
          cd ${{ env.K_ROOT }}
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" -o -name "gki_defconfig" | head -n 1)
          
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_KALLSYMS_ALL=y"
            echo "CONFIG_UNUSED_SYMBOLS=y"
            echo "# CONFIG_IKCONFIG is not set"
          } >> "$DEF"
          echo "CONF_FILE=$(basename $DEF)" >> $GITHUB_ENV

      - name: 7. 【正式编译】执行 LLVM 极致构建
        run: |
          cd ${{ env.K_ROOT }}
          # 设置版本号
          sed -i 's/EXTRAVERSION =.*/EXTRAVERSION = -PLC110-V37-Custom/g' Makefile
          
          # 编译指令 (完全复刻 cctv 生产级参数)
          export PATH="${{ env.CLANG_PATH }}:$PATH"
          make O=out ARCH=arm64 "${{ env.CONF_FILE }}"
          make O=out ARCH=arm64 \
               CC=clang \
               LD=ld.lld \
               AR=llvm-ar \
               NM=llvm-nm \
               OBJCOPY=llvm-objcopy \
               OBJDUMP=llvm-objdump \
               STRIP=llvm-strip \
               CROSS_COMPILE=aarch64-linux-gnu- \
               CROSS_COMPILE_COMPAT=arm-linux-gnueabi- \
               LLVM=1 LLVM_IAS=1 \
               -j$(nproc)

      - name: 8. 【打包产物】AnyKernel3
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/Image
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../PLC110_V37_Result.zip *

      - name: 9. 上传
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V37-Final
          path: "*.zip"
