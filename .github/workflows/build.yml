name: Build & Package PLC110 Kernel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 环境准备
        run: |
          sudo apt-get update
          sudo apt-get install -y bc bison build-essential flex gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu git git-lfs gnupg gperf libncurses5-dev libssl-dev python3 rsync zip

      - name: 源码同步
        run: |
          mkdir kernel && cd kernel
          git config --global user.email "bot@example.com"
          git config --global user.name "KernelBot"
          repo init -u https://github.com/SHuiTU68/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml
          repo sync -c -j$(nproc) --force-sync --no-clone-bundle --no-tags

      - name: 集成 KernelSU (Pershoot Hybrid)
        run: |
          cd kernel/common
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -s pershoot

      - name: 应用风驰补丁
        run: |
          cd kernel/common
          wget https://raw.githubusercontent.com/SHuiTU68/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          git apply fengchi.patch || echo "补丁应用略有冲突，请检查源码"

      - name: 禁用 KPROBES (方案1)
        run: |
          cd kernel/common
          find arch/arm64/configs/ -name "*defconfig*" -exec sed -i 's/CONFIG_KPROBES=y/CONFIG_KPROBES=n/g' {} +
          echo "CONFIG_KPROBES=n" >> arch/arm64/configs/gki_defconfig

      - name: 执行编译
        run: |
          cd kernel
          chmod +x build_kernel.sh
          ./build_kernel.sh plc110

      - name: 使用 AnyKernel3 打包
        run: |
          # 克隆 AK3 模版（根据你截图的 Wild 风格，这里建议拉取基础模版）
          git clone https://github.com/osm0sis/AnyKernel3.git AK3
          
          # 复制编译出的内核 Image 到 AK3 目录
          # 路径通常在 kernel/out/arch/arm64/boot/Image
          cp kernel/out/arch/arm64/boot/Image AK3/
          
          # 针对 PLC110 修改 anykernel.sh 配置 (参考你截图的内容)
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' AK3/anykernel.sh
          sed -i 's/block=auto/block=boot/g' AK3/anykernel.sh
          
          # 制作 Zip 包
          cd AK3
          zip -r ../PLC110-Kernel-KSU-SUSFS.zip *

      - name: 上传刷机包
        uses: actions/upload-artifact@v4
        with:
          name: PLC110_Kernel_Flashable
          path: PLC110-Kernel-KSU-SUSFS.zip
