name: PLC110_Full_Fix_V14
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. çŽ¯å¢ƒå‡†å¤‡
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. ã€æ ¸å¿ƒæŽ¥å›žã€‘æžé€Ÿæ‹‰å–ä¸€åŠ å®˜æ–¹åº•åº§
        run: |
          mkdir -p workspace && cd workspace
          # æ¢å¤ä¹‹å‰è¿è¡ŒæˆåŠŸçš„æžé€Ÿæ‹‰å–å‘½ä»¤
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # å‡†ç¡®å®šä½å†…æ ¸æ ¹ç›®å½•
          K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)
          echo "K_ROOT=$K_ROOT" >> $GITHUB_ENV

      - name: 3. ã€å…¨åŸŸæœå¯»ã€‘æ··åˆé’©å­ + æš´åŠ›è¡¥ä¸ä¿åº•
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          GKI_LIST=("https://github.com/simonpunk/KernelSU" "https://github.com/rifsxd/KernelSU-Next" "https://github.com/WildKernels/KernelSU")
          FOUND=false
          for repo in "${GKI_LIST[@]}"; do
            for branch in next hybrid-next gki-android14-6.6; do
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -q "HYBRID_HOOK"; then
                echo "ðŸŽ¯ åŒ¹é…æˆåŠŸ: $repo åˆ†æ”¯: $branch"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu && FOUND=true && break 2
              fi
            done
          done
          if [ "$FOUND" = false ]; then
            echo "âš ï¸ æœªå‘çŽ°åˆ†æ”¯ï¼Œå¯åŠ¨æš´åŠ›è¡¥ä¸..."
            git clone -b next --depth=1 https://github.com/rifsxd/KernelSU-Next drivers/kernelsu
            # ç‰©ç†ç»‡å…¥æ··åˆé’©å­å®å®šä¹‰
            sed -i '/config KSU_NEXT$/a \    bool "Enable Hybrid Hook"\n    default y' drivers/kernelsu/ksu/Kconfig
            find drivers/kernelsu/ -name "*.c" | xargs sed -i 's/ifndef CONFIG_KSU_NEXT_HYBRID_HOOK/if 1 \/\/ Forced/g'
          fi

      - name: 4. ã€æ‹†åˆ†æ­¥éª¤ã€‘æ³¨å…¥ ADIOS è°ƒåº¦å™¨
        continue-on-error: true  # å…è®¸è°ƒåº¦å™¨æ³¨å…¥å¤±è´¥è€Œä¸ä¸­æ–­æµç¨‹
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          # ä½¿ç”¨ V12 éªŒè¯è¿‡çš„è·¯å¾„å®šä½é€»è¾‘
          TARGET_K=$(find . -name "Kconfig" -path "*/sched/*" | head -n 1)
          TARGET_M=$(find . -name "Makefile" -path "*/sched/*" | head -n 1)
          if [ -n "$TARGET_K" ]; then
             echo 'obj-y += adios/' >> "$TARGET_M"
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TARGET_K"
             [ -d "kernel/sched/adios" ] && find kernel/sched/adios/ -type f -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'
          fi

      - name: 5. ã€æ‹†åˆ†æ­¥éª¤ã€‘æ³¨å…¥ Baseband-guard (BBG)
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 6. ã€ç‰©ç†é”å®šã€‘å†™å…¥ defconfig é…ç½®å®
        run: |
          cd ${{ env.K_ROOT }}
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          echo "ðŸ”§ ä¿®æ”¹é…ç½®æ–‡ä»¶: $DEF"
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
          } >> "$DEF"

      - name: 7. æ‰§è¡Œç¼–è¯‘ (LLVM 19)
        run: |
          cd ${{ env.K_ROOT }}
          CONF_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$CONF_NAME"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. æ‰“åŒ…ä¸Žä¸Šä¼ 
        run: |
          cd ${{ env.K_ROOT }}
          IMAGE=$(find out/ -name Image | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMAGE" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_GKI_V14.zip *
