name: PLC110_Ultimate_Fast_Search
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. åŒæ­¥åº•åº§ (Midas/PLC110)
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          
          # åŠ¨æ€å®šä½ 6.6 å†…æ ¸æ ¹ç›®å½•
          REAL_KERNEL_DIR=$(find $(pwd) -name "Makefile" | xargs grep -l "VERSION = 6" | head -n 1 | xargs dirname)
          echo "REAL_KERNEL_DIR=$REAL_KERNEL_DIR" >> $GITHUB_ENV

      - name: 3. ã€æé€Ÿæ–¹æ¡ˆã€‘å…¨åˆ†æ”¯æœå¯»æ··åˆé’©å­
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          rm -rf drivers/kernelsu
          
          # è·å–è¿œç¨‹ä»“åº“æ‰€æœ‰åˆ†æ”¯åˆ—è¡¨
          REPO_URL="https://github.com/rifsxd/KernelSU-Next"
          echo ">>> æ­£åœ¨è·å–è¿œç¨‹åˆ†æ”¯å…ƒæ•°æ®..."
          BRANCHES=$(git ls-remote --heads $REPO_URL | awk -F'refs/heads/' '{print $2}')
          
          FOUND_BRANCH=""
          # ä¼˜å…ˆçº§æ’åºï¼šé¦–å…ˆæ£€æŸ¥ next åˆ†æ”¯
          SORTED_BRANCHES="next $(echo "$BRANCHES" | grep -v "next")"

          for branch in $SORTED_BRANCHES; do
            echo "ğŸ” æ­£åœ¨æ£€æŸ¥åˆ†æ”¯: $branch ..."
            # ä½¿ç”¨ --filter=blob:none å®ç°æé€Ÿæµ…å…‹éš†æ¢æµ‹
            git clone -b "$branch" --depth=1 --filter=blob:none --sparse $REPO_URL drivers/kernelsu_tmp
            
            # æ¢æµ‹è¯¥åˆ†æ”¯æ˜¯å¦åŒ…å«æ··åˆé’©å­é€»è¾‘ (æœç´¢ Kconfig ä¸­çš„å…³é”®å®)
            if grep -rq "HYBRID_HOOK" drivers/kernelsu_tmp/ksu 2>/dev/null; then
              echo "âœ… åœ¨åˆ†æ”¯ [$branch] ä¸­å‘ç°æ··åˆé’©å­é€»è¾‘ï¼"
              FOUND_BRANCH=$branch
              mv drivers/kernelsu_tmp drivers/kernelsu
              break
            else
              rm -rf drivers/kernelsu_tmp
            fi
          done

          if [ -z "$FOUND_BRANCH" ]; then
            echo "âŒ æœªèƒ½åœ¨æ‰€æœ‰åˆ†æ”¯ä¸­æ‰¾åˆ°æ··åˆé’©å­ï¼Œå›é€€åˆ°ä¸»åˆ†æ”¯"
            git clone --depth=1 $REPO_URL drivers/kernelsu
          fi

      - name: 4. æ³¨å…¥ ADIOS ä¸ BBG (é€‚é… sugov_ext)
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          # ç…§æ¬ cctv ç§»æ¤é€»è¾‘
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          
          # ä¿®å¤ 1000022697 è·¯å¾„æŠ¥é”™ï¼šåŠ¨æ€æŸ¥æ‰¾ Kconfig ä½ç½®
          SCHED_KCONFIG=$(find kernel/sched/ -name "Kconfig" | head -n 1)
          SCHED_MAKEFILE=$(find kernel/sched/ -name "Makefile" | head -n 1)
          
          echo 'obj-y += adios/' >> "$SCHED_MAKEFILE"
          sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$SCHED_KCONFIG"
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig
          
          # 6.6 å†…æ ¸å…¼å®¹æ€§å¤´æ–‡ä»¶ä¿®å¤
          find kernel/sched/adios/ -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'

      - name: 5. æè‡´è¿˜åŸï¼šæ€§èƒ½è¡¥ä¸ä¸ sugov_ext å®é…ç½®
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          curl -L https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          patch -p1 < fengchi.patch || echo "è¡¥ä¸éƒ¨åˆ†è·³è¿‡"
          
          # å¯»æ‰¾å¯¹åº”çš„ defconfig
          DEFCONFIG=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
            echo "CONFIG_MTK_SCHED_BOOST=y"
          } >> "$DEFCONFIG"

      - name: 6. æ‰§è¡Œ LLVM ç¼–è¯‘
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          make O=out ARCH=arm64 $(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig"))
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 7. æ‰“åŒ…äº§ç‰©
        run: |
          IMAGE_PATH=$(find . -name "Image" -path "*/out/*" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMAGE_PATH" AnyKernel3/
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../PLC110_Extreme_$(date +%m%d).zip *

      - name: 8. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-Extreme-Kernel
          path: "*.zip"
