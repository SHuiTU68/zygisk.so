name: Rebuild-PLC110-Ultimate
on:
  workflow_dispatch:

jobs:
  build_kernel:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境初始化
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: 2. 安装核心依赖
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git libelf-dev libssl-dev lz4 liblz4-tool python3-pip zip tar curl sed uuid-dev wget pahole
          echo "Build tools installed."

      - name: 3. 源码与 Clang 智能同步
        run: |
          # 动态尝试一加 PLC110 源码分支，解决 exit code 128
          REPO="https://github.com/OnePlusOSS/android_kernel_oneplus_mt6991"
          git clone --depth=1 $REPO -b oneplus/mtk6991 kernel_src || \
          git clone --depth=1 $REPO -b oneplus/mt6991 kernel_src || \
          git clone --depth=1 $REPO kernel_src
          
          # 拉取 AOSP 官方 Clang r522830
          mkdir clang
          curl -LSs https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522830.tar.gz | tar -xzC clang
          
          # 核心：注入 Pershoot 分支以支持 Hybrid Hook
          cd kernel_src
          curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/main/kernel/setup.sh" | bash -s main

      - name: 4. 注入风驰补丁与性能调优
        run: |
          cd kernel_src
          # 注入风驰游戏补丁
          curl -LO https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          patch -p1 < fengchi.patch || echo "Patch already applied or skipped"

          # 强制 O2 性能优化
          sed -i 's/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y/g' arch/arm64/configs/gki_defconfig
          sed -i 's/-Os/-O2/g' Makefile

          # 方案一：禁用 Kprobes 以实现混合钩子 (Hybrid Hook)
          echo "CONFIG_KPROBES=n" >> arch/arm64/configs/gki_defconfig
          echo "CONFIG_KPROBE_EVENTS=n" >> arch/arm64/configs/gki_defconfig

      - name: 5. 开启正式编译
        run: |
          cd kernel_src
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 6. 打包 AnyKernel3 (同步截图逻辑)
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 AK3
          cd AK3
          rm -rf .git README.md
          
          # 写入完全匹配你截图的刷写逻辑
          cat <<EOF > anykernel.sh
### AnyKernel3 Ramdisk Mod Script
properties() { '
kernel.string=KSUN-PLC110-O2-Hybrid
do.devicecheck=0
do.modules=0
do.systemless=0
do.cleanup=1
device.name1=PLC110
supported.versions=14, 15
'; }

block=boot;
is_slot_device=auto;
ramdisk_compression=auto;
patch_vbmeta_flag=auto;
no_magisk_check=1;

. tools/ak3-core.sh;

# 检测 5.1/6.1/6.6 内核版本
kernel_version=\$(cat /proc/version | awk -F '-' '{print \$1}' | awk '{print \$3}')
case \$kernel_version in
  5.1*) ksu_supported=true ;;
  6.1*) ksu_supported=true ;;
  6.6*) ksu_supported=true ;;
  *) ksu_supported=false ;;
esac

ui_print " " "-> Wild Kernels Supported: \$ksu_supported"
\$ksu_supported || abort " -> Non-GKI device, abort."

split_boot;
if [ -f "split_img/ramdisk.cpio" ]; then
  unpack_ramdisk;
  write_boot;
else
  flash_boot;
fi
EOF

          # 提取 Image 镜像 (约 36.30M)
          cp ../kernel_src/out/arch/arm64/boot/Image ./Image
          zip -r ../KSUN-PLC110-O2-Hybrid.zip *

      - name: 7. 上传编译产物
        uses: actions/upload-artifact@v4
        with:
          name: KSUN-PLC110-O2-Hybrid
          path: "*.zip"
