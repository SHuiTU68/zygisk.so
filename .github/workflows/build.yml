name: PLC110_Hyper_Fast_Global_Search
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘åªæ‹‰å–æ ¸å¿ƒå†…æ ¸æºç 
        run: |
          mkdir -p workspace && cd workspace
          # ä½¿ç”¨ --partial-clone å’Œ --depth=1 æå¤§æå‡é€Ÿåº¦
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1 --partial-clone
          # åªåŒæ­¥å†…æ ¸æ ¸å¿ƒéƒ¨åˆ†ï¼Œè·³è¿‡å†—ä½™å·¥å…·é“¾
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle --optimized-fetch
          
          # è‡ªåŠ¨å®šä½ 6.6 å†…æ ¸çœŸå®æ ¹ç›®å½•
          REAL_KERNEL_DIR=$(find $(pwd) -name "Makefile" | xargs grep -l "VERSION = 6" | head -n 1 | xargs dirname)
          echo "REAL_KERNEL_DIR=$REAL_KERNEL_DIR" >> $GITHUB_ENV

      - name: 3. ã€å…¨åŸŸæœå¯»ã€‘å¯»æ‰¾æœ€å¼ºæ··åˆé’©å­
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          rm -rf drivers/kernelsu
          
          # å®šä¹‰å…¨åŸŸå€™é€‰ä»“åº“
          REPOS=(
            "https://github.com/rifsxd/KernelSU-Next"
            "https://github.com/WildKernels/KernelSU"
            "https://github.com/tiann/KernelSU"
            "https://github.com/rsuntk/KernelSU"
          )

          FOUND=false
          for repo in "${REPOS[@]}"; do
            echo "ğŸŒ æ­£åœ¨æ¢æµ‹ä»“åº“: $repo"
            # è·å–æ‰€æœ‰åˆ†æ”¯å
            BRANCHES=$(git ls-remote --heads $repo | awk -F'refs/heads/' '{print $2}')
            
            for branch in $BRANCHES; do
              echo "ğŸ” æ£€æŸ¥åˆ†æ”¯: $branch"
              # ä»…æ¢æµ‹ Kconfig æ–‡ä»¶
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -q "HYBRID_HOOK"; then
                echo "ğŸ¯ å‘ç°æ··åˆé’©å­ï¼æ­£åœ¨æ‹‰å– $repo çš„ $branch åˆ†æ”¯"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu
                FOUND=true
                break 2
              fi
            done
          done

          if [ "$FOUND" = false ]; then
            echo "âš ï¸ å…¨åŸŸæœªå‘ç°æ··åˆé’©å­ï¼Œå›é€€è‡³ rifsxd é»˜è®¤åˆ†æ”¯"
            git clone --depth=1 https://github.com/rifsxd/KernelSU-Next drivers/kernelsu
          fi

      - name: 4. æ³¨å…¥ ADIOS ä¸ BBG (é€‚é… sugov_ext)
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          
          # åŠ¨æ€ä¿®å¤ Kconfig è·¯å¾„ï¼Œé˜²æ­¢ 1000022697 çš„æŠ¥é”™
          KCONFIG_FILE=$(find kernel/sched/ -name "Kconfig" | head -n 1)
          MAKEFILE_FILE=$(find kernel/sched/ -name "Makefile" | head -n 1)
          echo 'obj-y += adios/' >> "$MAKEFILE_FILE"
          sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$KCONFIG_FILE"
          
          # 6.6 å†…æ ¸å¤´æ–‡ä»¶å…¼å®¹ä¿®å¤
          find kernel/sched/adios/ -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'

      - name: 5. æè‡´è¿˜åŸ cctv ä¼˜åŒ–é…ç½®
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          curl -L https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          patch -p1 < fengchi.patch || echo "è¡¥ä¸å†²çªå·²è·³è¿‡"
          
          DEFCONFIG=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
          } >> "$DEFCONFIG"

      - name: 6. å¼€å¯äº‘ç«¯é«˜é€Ÿç¼–è¯‘
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          # è‡ªåŠ¨å¯»æ‰¾å¹¶åº”ç”¨ defconfig
          CONF=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig"))
          make O=out ARCH=arm64 "$CONF"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 7. æ‰“åŒ…äº§ç‰©
        run: |
          IMAGE=$(find . -name "Image" -path "*/out/*" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMAGE" AnyKernel3/
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../PLC110_Extreme_$(date +%m%d).zip *

      - name: 8. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-Extreme-Kernel
          path: "*.zip"
