name: PLC110_Ultimate_Build
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 环境准备
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. 同步官方底座 (使用 Repo)
        run: |
          mkdir -p android/kernel && cd android/kernel
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle

      - name: 3. 注入 KSUN-Next (混合钩子)
        # 强制指定在源码所在目录运行，修复 No such file 报错
        run: |
          cd android/kernel/common
          rm -rf drivers/kernelsu
          git clone -b next --depth=1 https://github.com/rifsxd/KernelSU-Next drivers/kernelsu
          echo "✅ 混合钩子驱动已注入"

      - name: 4. 注入 ADIOS 调度器
        run: |
          cd android/kernel/common
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios
          echo 'obj-y += adios/' >> kernel/sched/Makefile
          # 动态挂载 Kconfig
          sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' kernel/sched/Kconfig
          echo "✅ ADIOS 调度器已挂载"

      - name: 5. 注入 Baseband-guard (BBG)
        run: |
          cd android/kernel/common
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig
          echo "✅ BBG 基带守护已挂载"

      - name: 6. 应用性能补丁与配置宏
        run: |
          cd android/kernel/common
          # 下载补丁
          curl -L https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          patch -p1 < fengchi.patch || echo "⚠️ 部分补丁冲突，已跳过"
          
          # 开启所有核心优化宏
          DEFCONFIG="arch/arm64/configs/oplus_mt6991_defconfig"
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
          } >> $DEFCONFIG

      - name: 7. 执行编译 (天玑 9400)
        run: |
          cd android/kernel/common
          make O=out ARCH=arm64 oplus_mt6991_defconfig
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. 打包 AnyKernel3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3
          cp android/kernel/common/out/arch/arm64/boot/Image AnyKernel3/
          cd AnyKernel3
          sed -i 's/do.devicecheck=1/do.devicecheck=0/g' anykernel.sh
          zip -r9 ../PLC110_Ultimate_Kernel.zip *

      - name: 9. 发布产物
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-Extreme-Kernel
          path: PLC110_Ultimate_Kernel.zip
