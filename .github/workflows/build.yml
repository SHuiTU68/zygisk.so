name: PLC110_Ultimate_GKI_V12
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒåŠ å›º
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘è·³è¿‡å†—ä½™ï¼Œä»…æ ¸å¿ƒåº•åº§
        run: |
          mkdir -p workspace && cd workspace
          # å¼ºåˆ¶å¼€å¯ depth=1 ç¡®ä¿ 1000022706 çš„ç§’çº§é€Ÿåº¦
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # æè‡´è·¯å¾„å®šä½ï¼šæŸ¥æ‰¾åŒ…å« arch æ–‡ä»¶å¤¹çš„å†…æ ¸æ ¹éƒ¨
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. ã€å½»åº•æœå¯»ã€‘å…¨ç½‘ GKI æ··åˆé’©å­æ¢æµ‹
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          
          # åŒ…å« simonpunk (é…·å®‰å¤§ä½¬) åŠå…¶ä»–æ··åˆé’©å­æº
          GKI_LIST=(
            "https://github.com/simonpunk/KernelSU"
            "https://github.com/rifsxd/KernelSU-Next"
            "https://github.com/WildKernels/KernelSU"
            "https://github.com/tiann/KernelSU"
            "https://github.com/rsuntk/KernelSU"
            "https://github.com/idsc-dev/KernelSU"
          )

          FOUND=false
          for repo in "${GKI_LIST[@]}"; do
            echo "ğŸŒ æ¢æµ‹ä»“åº“: $repo"
            # é’ˆå¯¹ 6.6 å†…æ ¸ï¼Œé‡ç‚¹æ¢æµ‹ hybrid ç›¸å…³åˆ†æ”¯
            for branch in next main master gki-android14-6.6 hybrid-next; do
              # å…³é”®ï¼šæ£€æŸ¥å®å®šä¹‰æ˜¯å¦å­˜åœ¨
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -qE "HYBRID_HOOK|CONFIG_KSU_NEXT"; then
                echo "ğŸ¯ å‘ç°æ··åˆé’©å­ï¼æº: $repo åˆ†æ”¯: $branch"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu
                FOUND=true && break 2
              fi
            done
          done

      - name: 4. ã€è§£å†³ sed æŠ¥é”™ã€‘ADIOS ç‰©ç†æ³¨å…¥
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          
          # å½»åº•è§£å†³ 1000022709 çš„ "no input files" é—®é¢˜
          # ä¸å†çŒœæµ‹è·¯å¾„ï¼Œç›´æ¥é€šè¿‡æ–‡ä»¶åå…¨å±€æœå¯»å¹¶è·å–ç¬¬ä¸€ä¸ªåŒ¹é…ç»“æœ
          TARGET_KCONFIG=$(find . -name "Kconfig" -path "*/sched/*" | head -n 1)
          TARGET_MAKEFILE=$(find . -name "Makefile" -path "*/sched/*" | head -n 1)
          
          if [ -n "$TARGET_KCONFIG" ]; then
             echo "âœ… æ³¨å…¥è·¯å¾„: $TARGET_KCONFIG"
             echo 'obj-y += adios/' >> "$TARGET_MAKEFILE"
             # ç¡®ä¿åœ¨ endmenu ä¹‹å‰æ’å…¥ï¼Œé¿å…è¯­æ³•é”™è¯¯
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TARGET_KCONFIG"
             # ä¿®å¤ 6.6 å¤´æ–‡ä»¶å†²çª
             find kernel/sched/adios/ -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'
          fi

      - name: 5. ã€ç…§æ¬ cctvã€‘æ³¨å…¥ BBG ä¸ æ€§èƒ½è¡¥ä¸
        run: |
          cd ${{ env.K_ROOT }}
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig
          # åº”ç”¨é£é©° (Fengchi) ä¼˜åŒ–
          curl -L https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o f.patch
          patch -p1 < f.patch || echo "è¡¥ä¸è·³è¿‡"

      - name: 6. ã€ç‰©ç†é”å®šã€‘å¼€å¯ cctv ä¼˜åŒ–å®
        run: |
          cd ${{ env.K_ROOT }}
          # é’ˆå¯¹ 1000022705 çš„ç©ºè·¯å¾„ä¿®å¤
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          
          echo "ğŸ”§ ä¿®æ”¹é…ç½®æ–‡ä»¶: $DEF"
          {
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
          } >> "$DEF"

      - name: 7. æ‰§è¡Œç¼–è¯‘
        run: |
          cd ${{ env.K_ROOT }}
          CONF_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$CONF_NAME"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. æ‰“åŒ…å‘å¸ƒ
        run: |
          IMAGE=$(find . -name "Image" -path "*/out/*" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMAGE" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_GKI_V12.zip *

      - name: 9. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V12-Kernel
          path: "*.zip"
