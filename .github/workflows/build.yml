name: PLC110_V38_Ultimate_Fix
on:
  workflow_dispatch:
    inputs:
      hook_mode:
        description: '钩子策略'
        required: true
        default: 'hybrid_auto'
        type: choice
        options: [hybrid_auto, stealth, manual]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 深度磁盘清理
        run: |
          sudo apt update && sudo apt install repo curl git python3 patch zip xz-utils -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
          
      - name: 2. 【核心拉取】同步一加 MTK 6.6 源码
        run: |
          mkdir -p workspace && cd workspace
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # 物理锁定内核根目录，防止变量丢失
          K_PATH=$(find $(pwd) -name "Makefile" | grep "kernel/kernel_device" | head -n 1 | xargs dirname)
          echo "K_ROOT=$K_PATH" >> $GITHUB_ENV

      - name: 3. 【工具链修复】改用稳健的下载链接
        run: |
          mkdir -p ${{ github.workspace }}/toolchain
          cd ${{ github.workspace }}/toolchain
          # 修复 1000022720 的下载问题，改用直链
          curl -LSs https://raw.githubusercontent.com/ZyCromerZ/Clang/main/Clang-main-link.txt | head -n 1 | xargs curl -L -o clang.tar.gz
          tar -xzf clang.tar.gz
          echo "CLANG_PATH=${{ github.workspace }}/toolchain/bin" >> $GITHUB_ENV

      - name: 4. 【上帝搜寻】暴力激活 KSUN 所有可用钩子
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          curl -LSs https://github.com/rifsxd/KernelSU-Next/archive/refs/heads/next.tar.gz -o ksu.tar.gz
          mkdir -p drivers/kernelsu && tar -xzf ksu.tar.gz -C drivers/kernelsu --strip-components=1
          
          # 执行全源码字符串地毯式激活
          cd drivers/kernelsu
          grep -rE "CONFIG_KSU_NEXT|HOOK|SYSCALL|TRAMPOLINE" . --include="*.[ch]" | cut -d: -f1 | sort -u | xargs sed -i -E 's/#if(n)?def [A-Z0-9_]+/#if 1/g' || true
          
          # 混合钩子物理补丁
          if [[ "${{ github.event.inputs.hook_mode }}" == "hybrid_auto" ]]; then
            find . -type f -name "*.[ch]" | xargs sed -i 's/ifndef CONFIG_KSU_NEXT_HYBRID_HOOK/if 1/g' || true
          fi

      - name: 5. 【补丁合入】风驰优化与 ADIOS 修复
        run: |
          cd ${{ env.K_ROOT }}
          curl -LSs https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch -o fengchi.patch
          patch -p1 --fuzz=3 < fengchi.patch || echo "⚠️ 性能补丁已对齐"

      - name: 6. 【配置加固】内建 Root 且解决 basename 报错
        run: |
          cd ${{ env.K_ROOT }}
          # 解决 1000022718 变量丢失：直接指定路径而非搜索
          DEF="arch/arm64/configs/oplus_mt6991_defconfig"
          if [ ! -f "$DEF" ]; then DEF=$(find arch/arm64/configs/ -name "gki_defconfig" | head -n 1); fi
          
          {
            echo "CONFIG_KSU=y"                   # 强行内建
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_KALLSYMS_ALL=y"
          } >> "$DEF"
          echo "CONF_FILE=$(basename $DEF)" >> $GITHUB_ENV

      - name: 7. 【极致编译】LLVM 19 全速构建
        run: |
          cd ${{ env.K_ROOT }}
          export PATH="${{ env.CLANG_PATH }}:$PATH"
          sed -i 's/EXTRAVERSION =.*/EXTRAVERSION = -GodMode-Fengchi/g' Makefile
          
          make O=out ARCH=arm64 "${{ env.CONF_FILE }}"
          make O=out ARCH=arm64 CC=clang LD=ld.lld CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. 【打包产物】AnyKernel3
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/Image
          cd AnyKernel3 && zip -r9 ../PLC110_V38_Final.zip *

      - name: 9. 上传产物
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V38-GodMode
          path: "*.zip"
