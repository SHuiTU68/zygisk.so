
name: Build-PLC110-Corrected
on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        # 对应你截图中的两个作业方案
        hook_type: [disable_kprobes, modify_source]
    runs-on: ubuntu-latest
    steps:
      - name: Maximize Build Space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 16384
          remove-dotnet: 'true'
          remove-android: 'true'

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git libelf-dev libssl-dev lz4 liblz4-tool python3-pip zip tar curl sed uuid-dev wget pahole

      - name: Sync Source & Pershoot KSUN
        run: |
          # 修正分支名错误：请确保 oneplus/mtk6991 是正确的，若报错请尝试改为 oneplus/mt6991
          git clone --depth=1 https://github.com/OnePlusOSS/android_kernel_oneplus_mt6991 -b oneplus/mtk6991 kernel_src || \
          git clone --depth=1 https://github.com/OnePlusOSS/android_kernel_oneplus_mt6991 kernel_src
          
          # 拉取 Clang r522830
          mkdir clang
          curl -LSs https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522830.tar.gz | tar -xzC clang
          
          # 调用 pershoot 分支以支持 Hybrid Hook
          cd kernel_src
          curl -LSs "https://raw.githubusercontent.com/pershoot/KernelSU-Next/main/kernel/setup.sh" | bash -s main

      - name: Advanced Optimization & Patching
        run: |
          cd kernel_src
          # 注入风驰游戏补丁
          curl -LO https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          patch -p1 < fengchi.patch || echo "Patch skip"

          # 强制 O2 优化
          sed -i 's/CONFIG_CC_OPTIMIZE_FOR_SIZE=y/CONFIG_CC_OPTIMIZE_FOR_PERFORMANCE=y/g' arch/arm64/configs/gki_defconfig
          sed -i 's/-Os/-O2/g' Makefile

          # 针对方案二进行源码硬改
          if [ "${{ matrix.hook_type }}" == "modify_source" ]; then
            sed -i '/CONFIG_KPROBES/d' kernel/Kbuild
            sed -i '/IS_ENABLED(CONFIG_KPROBES)/d' kernel/supercalls.c
          else
            echo "CONFIG_KPROBES=n" >> arch/arm64/configs/gki_defconfig
            echo "CONFIG_KPROBE_EVENTS=n" >> arch/arm64/configs/gki_defconfig
          fi

      - name: Start Build
        run: |
          cd kernel_src
          export PATH=$GITHUB_WORKSPACE/clang/bin:$PATH
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 gki_defconfig
          make O=out ARCH=arm64 CC=clang LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: Package AK3
        run: |
          git clone https://github.com/osm0sis/AnyKernel3 AK3
          cd AK3
          rm -rf .git README.md
          
          # 写入完全匹配你截图的 anykernel.sh
          cat <<EOF > anykernel.sh
### AnyKernel3 Ramdisk Mod Script
properties() { '
kernel.string=KSUN for PLC110-O2-Hybrid
do.devicecheck=0
do.modules=0
do.systemless=0
do.cleanup=1
device.name1=PLC110
supported.versions=14, 15
'; }

block=boot;
is_slot_device=auto;
ramdisk_compression=auto;
patch_vbmeta_flag=auto;
no_magisk_check=1;

. tools/ak3-core.sh;

kernel_version=\$(cat /proc/version | awk -F '-' '{print \$1}' | awk '{print \$3}')
case \$kernel_version in
  5.1*) ksu_supported=true ;;
  6.1*) ksu_supported=true ;;
  6.6*) ksu_supported=true ;;
  *) ksu_supported=false ;;
esac

ui_print " " "-> Wild Kernels Supported: \$ksu_supported"
\$ksu_supported || abort " -> Non-GKI device, abort."

split_boot;
if [ -f "split_img/ramdisk.cpio" ]; then
  unpack_ramdisk;
  write_boot;
else
  flash_boot;
fi
EOF

          # 复制未压缩的 Image
          cp ../kernel_src/out/arch/arm64/boot/Image ./Image
          zip -r ../KSUN-PLC110-${{ matrix.hook_type }}.zip *

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: KSUN-PLC110-${{ matrix.hook_type }}
          path: "*.zip"
