name: PLC110_Ultimate_V18_Final
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡ä¸ç£ç›˜ç©ºé—´æ¸…ç†
        run: |
          sudo apt update && sudo apt install repo curl git python3 patch zip -y
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘æ‹‰å–ä¸€åŠ åº•åº§ (1.5åˆ†é’Ÿé€»è¾‘)
        run: |
          mkdir -p workspace && cd workspace
          # æ¢å¤ä½ æˆªå›¾ä¸­æœ€æˆåŠŸçš„æé€Ÿæ‹‰å–å‘½ä»¤
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # åŠ¨æ€è·å–å†…æ ¸æ ¹ç›®å½•ï¼Œé˜²æ­¢ find æŠ¥é”™
          echo "K_ROOT=$(find $(pwd) -name "arch" -type d | head -n 1 | xargs dirname)" >> $GITHUB_ENV

      - name: 3. ã€åŸç”Ÿé€‚é…ã€‘æ‹‰å– 6.6 ä¸“å±æ··åˆé’©å­é©±åŠ¨
        run: |
          cd ${{ env.K_ROOT }}
          rm -rf drivers/kernelsu
          # ç›´æ¥å…‹éš†å·²ä¸º 6.6 é€‚é…å¥½æ··åˆé’©å­çš„ä»“åº“ï¼Œè·³è¿‡ä¸ç¨³å®šçš„æš´åŠ› Patch
          git clone -b gki-android15-6.6 --depth=1 https://github.com/WildKernels/KernelSU drivers/kernelsu
          
          # å¤‡ç”¨æ–¹æ¡ˆï¼šå¦‚æœä¸Šé¢åˆ†æ”¯å¤±æ•ˆï¼Œæ‹‰å– simonpunk çš„ä¸»åˆ†æ”¯
          if [ ! -d "drivers/kernelsu/ksu" ]; then
            git clone -b main --depth=1 https://github.com/simonpunk/KernelSU drivers/kernelsu
          fi
          echo "âœ… é©±åŠ¨ç›®å½•çŠ¶æ€: $(ls -d drivers/kernelsu/ksu)"

      - name: 4. ã€æ€§èƒ½çµé­‚ã€‘æ³¨å…¥ cctv é£é©°æ¸¸æˆå†…æ ¸è¡¥ä¸
        run: |
          cd ${{ env.K_ROOT }}
          echo "ğŸš€ æ­£åœ¨ä¸‹è½½ cctv å¤§ä½¬çš„é£é©°ä¼˜åŒ–è¡¥ä¸..."
          curl -LO https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          # å°è¯•åº”ç”¨è¡¥ä¸ï¼Œå…è®¸ 3 è¡Œä»¥å†…çš„ä½ç½®åå·®
          patch -p1 --fuzz=3 < fengchi.patch || echo "âš ï¸ è¡¥ä¸å­˜åœ¨éƒ¨åˆ†å†²çªï¼Œå·²è·³è¿‡å†²çªè¡Œ"

      - name: 5. ã€æ¨¡å—æ³¨å…¥ã€‘ADIOS ä¸ BBG è·¯å¾„è‡ªé€‚åº”
        continue-on-error: true # å…è®¸è°ƒåº¦å™¨æ³¨å…¥å¤±è´¥è€Œä¸ä¸­æ–­ä»»åŠ¡
        run: |
          cd ${{ env.K_ROOT }}
          # æ³¨å…¥ ADIOS
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          TK=$(find . -name "Kconfig" -path "*/sched/*" | head -n 1)
          TM=$(find . -name "Makefile" -path "*/sched/*" | head -n 1)
          if [ -n "$TK" ]; then
             echo 'obj-y += adios/' >> "$TM"
             sed -i '/endmenu/i source "kernel/sched/adios/Kconfig"' "$TK"
             # ä¿®å¤ 6.6 å¤´æ–‡ä»¶å†²çª
             find kernel/sched/adios/ -type f -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g' || true
          fi
          # æ³¨å…¥ BBG
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 6. ã€é…ç½®åŠ å›ºã€‘å†™å…¥æè‡´æ€§èƒ½å®
        run: |
          cd ${{ env.K_ROOT }}
          # è§£å†³ 1000022705 çš„ No such file or directory æŠ¥é”™
          DEF=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          [ -z "$DEF" ] && DEF="arch/arm64/configs/gki_defconfig"
          echo "ğŸ”§ æ­£åœ¨å†™å…¥é…ç½®åˆ°: $DEF"
          {
            echo "CONFIG_KSU=y"
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
            echo "CONFIG_FENGCHI_OPTIMIZE=y"
            echo "CONFIG_ADIOS_SCHED=y"
            echo "CONFIG_BASEBAND_GUARD=y"
            echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
            echo "CONFIG_MTK_SCHED_BOOST=y"
          } >> "$DEF"

      - name: 7. æ‰§è¡Œ LLVM 19 ç¼–è¯‘
        run: |
          cd ${{ env.K_ROOT }}
          C_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1))
          make O=out ARCH=arm64 "$C_NAME"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)

      - name: 8. æ‰“åŒ…å‘å¸ƒ
        run: |
          IMG=$(find ${{ env.K_ROOT }}/out -name "Image" | head -n 1)
          git clone https://github.com/osm0sis/AnyKernel3
          cp "$IMG" AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_Ultimate_V18.zip *

      - name: 9. ä¸Šä¼ ç»“æœ
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-V18-Final
          path: "*.zip"
