name: PLC110_Ultimate_GKI_Search_V11
on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. ç¯å¢ƒå‡†å¤‡
        run: sudo apt update && sudo apt install repo curl git python3 patch zip -y

      - name: 2. ã€æé€ŸåŒæ­¥ã€‘1.5åˆ†é’Ÿåº•åº§æ‹‰å–
        run: |
          mkdir -p workspace && cd workspace
          # ä½¿ç”¨ --depth=1 ä¿æŒæè‡´é€Ÿåº¦
          repo init -u https://github.com/WildKernels/OnePlus_KernelSU_SUSFS.git -b main -m manifests/oos16/oneplus_ace5_ultra_w.xml --depth=1
          repo sync -c -j$(nproc) --no-tags --no-clone-bundle
          # é€’å½’å®šä½å†…æ ¸çœŸæ­£çš„ Makefile æ‰€åœ¨åœ°ï¼Œé€‚é… 6.6 ç»“æ„
          K_DIR=$(find $(pwd) -name "Makefile" | xargs grep -l "VERSION = 6" | head -n 1 | xargs dirname)
          echo "REAL_KERNEL_DIR=$K_DIR" >> $GITHUB_ENV

      - name: 3. ã€å…¨åŸŸå½»åº•æœå¯»ã€‘å¯»æ‰¾æ··åˆé’©å­ (åŒ…å«é…·å®‰/GKIå¼€å‘è€…æº)
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          rm -rf drivers/kernelsu
          
          # æ‰©å¤§æœç´¢èŒƒå›´ï¼ŒåŒ…å«çŸ¥å GKI é€‚é…è€…ä»“åº“
          GKI_SOURCES=(
            "https://github.com/rifsxd/KernelSU-Next"
            "https://github.com/WildKernels/KernelSU"
            "https://github.com/tiann/KernelSU"
            "https://github.com/simonpunk/KernelSU"
            "https://github.com/idsc-dev/KernelSU"
            "https://github.com/bmax-dev/KernelSU"
          )

          FOUND=false
          for repo in "${GKI_SOURCES[@]}"; do
            echo "ğŸŒ æ­£åœ¨äº‘ç«¯æ¢æµ‹ä»“åº“: $repo"
            # å°è¯•æ¢æµ‹æ‰€æœ‰å¸¦æœ‰ hybrid é€»è¾‘çš„åˆ†æ”¯å
            for branch in next main master gki-android14-6.1 hybrid-next; do
              # å…³é”®ï¼šæ£€æŸ¥ Kconfig æ˜¯å¦æœ‰æ··åˆé’©å­æ ‡è®°
              if curl -sL "${repo}/raw/${branch}/ksu/Kconfig" | grep -E "HYBRID_HOOK|CONFIG_KSU_NEXT"; then
                echo "ğŸ¯ åŒ¹é…æˆåŠŸï¼æº: $repo åˆ†æ”¯: $branch"
                git clone -b "$branch" --depth=1 "$repo" drivers/kernelsu
                FOUND=true && break 2
              fi
            done
          done

      - name: 4. ã€å·²ä¿®å¤ã€‘æ³¨å…¥ ADIOS ä¸ BBG
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          # é’ˆå¯¹ 1000022702 æŠ¥é”™çš„å½»åº•ä¿®å¤é€»è¾‘
          git clone --depth=1 https://github.com/firelzrd/adios kernel/sched/adios || true
          
          # ç‰©ç†å®šä½è°ƒåº¦å™¨é…ç½®
          SCHED_K=$(find . -path "*/sched/Kconfig" | head -n 1)
          SCHED_M=$(find . -path "*/sched/Makefile" | head -n 1)
          
          # æŒ‚è½½å¹¶ä¿®å¤ 6.6 å†…æ ¸å¤´æ–‡ä»¶å†²çª
          echo 'obj-y += adios/' >> "$SCHED_M"
          sed -i "/endmenu/i source \"kernel/sched/adios/Kconfig\"" "$SCHED_K"
          find kernel/sched/adios/ -name "*.[ch]" | xargs sed -i 's/<linux\/sched\/rt.h>/<linux\/sched\/types.h>/g'
          
          # æ³¨å…¥ BBG
          git clone --depth=1 https://github.com/vc-teahouse/Baseband-guard drivers/bbg
          echo 'obj-y += bbg/' >> drivers/Makefile
          echo 'source "drivers/bbg/Kconfig"' >> drivers/Kconfig

      - name: 5. ã€ä¿®å¤å†™å…¥æŠ¥é”™ã€‘å¼€å¯æè‡´ä¼˜åŒ–å®
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          # é’ˆå¯¹ 1000022705 çš„ç‰©ç†è·¯å¾„å®šä½ä¿®å¤
          DEFCONFIG_FILE=$(find arch/arm64/configs/ -name "oplus_mt6991_defconfig" | head -n 1)
          
          if [ -f "$DEFCONFIG_FILE" ]; then
            echo "âœ… é”å®šé…ç½®æ–‡ä»¶: $DEFCONFIG_FILE"
            {
              echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y"
              echo "CONFIG_KSU_NEXT_KPROBE_REPLACE=y"
              echo "CONFIG_ADIOS_SCHED=y"
              echo "CONFIG_BASEBAND_GUARD=y"
              echo "CONFIG_FENGCHI_OPTIMIZE=y"
              echo "CONFIG_CPU_FREQ_GOV_SUGOV_EXT=y"
            } >> "$DEFCONFIG_FILE"
          else
            echo "âŒ æ‰¾ä¸åˆ° defconfigï¼Œå°è¯•å¼ºåˆ¶å†™å…¥ common é…ç½®"
            echo "CONFIG_KSU_NEXT_HYBRID_HOOK=y" >> arch/arm64/configs/gki_defconfig
          fi

      - name: 6. ç¼–è¯‘ä¸æ‰“åŒ…
        run: |
          cd ${{ env.REAL_KERNEL_DIR }}
          CONF_NAME=$(basename $(find arch/arm64/configs/ -name "oplus_mt6991_defconfig"))
          make O=out ARCH=arm64 "$CONF_NAME"
          make O=out ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- LLVM=1 LLVM_IAS=1 -j$(nproc)
          
          # é€‚é…æ‰“åŒ…
          git clone https://github.com/osm0sis/AnyKernel3
          cp $(find out/ -name Image) AnyKernel3/
          cd AnyKernel3 && zip -r9 ../PLC110_Ultimate_Extreme.zip *

      - name: 7. ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: PLC110-Extreme-Kernel
          path: "*.zip"
