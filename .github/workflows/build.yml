name: Build OnePlus MTK6991 Hybrid Kernel
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 环境准备
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison git libssl-dev libelf-dev clang lld llvm

      - name: 拉取源码
        run: |
          # 请确保此处地址正确，目前 OnePlus OSS 通常在 GitHub 上
          git clone --depth=1 https://github.com/OnePlusOSS/android_kernel_oneplus_mt6991.git kernel-source
          
      - name: 集成 KernelSU Next (Hybrid Hook 配置)
        run: |
          cd kernel-source
          # 安装 KSUN
          curl -LSs "https://raw.githubusercontent.com/rifsxd/KernelSU-Next/next/kernel/setup.sh" | bash -s next
          
          # 【关键】修改源码以启用 Hybrid Hook
          # 在 6.6 内核中，Hybrid 模式通常需要绕过 CONFIG_KPROBES 对某些 syscall 的接管
          # 脚本尝试在驱动入口强制定义 HYBRID 逻辑（根据 KSUN Next 规范）
          sed -i 's/CONFIG_KPROBES/CONFIG_KPROBES_AND_HYBRID/g' kernel/Makefile || true

      - name: 应用风驰 (Fengchi) Patch
        run: |
          cd kernel-source
          wget https://raw.githubusercontent.com/cctv18/oppo_oplus_realme_sm8750/main/other_patch/fengchi.patch
          
          # 强制应用补丁（忽略路径偏移）
          # 注意：如果 patch 是针对骁龙写的，路径不匹配时需要用 -p1 或手动 patch
          patch -p1 < fengchi.patch || echo "警告：补丁自动应用失败，可能需要手动对齐路径"

      - name: 注入内核配置 (Defconfig)
        run: |
          cd kernel-source
          # 针对 MT6991 的 GKI 配置
          DEFCONFIG="arch/arm64/configs/gki_defconfig"
          
          # 启用 KSUN 与 Hybrid Hook 必要项
          scripts/config --file $DEFCONFIG -e KSU
          scripts/config --file $DEFCONFIG -e KSU_NEXT
          scripts/config --file $DEFCONFIG -e KPROBES
          scripts/config --file $DEFCONFIG -e KPROBE_EVENTS
          # 针对风驰补丁可能需要的配置（例如伪装官方内核签名）
          scripts/config --file $DEFCONFIG -e OPLUS_FEATURE_FENGCHI
          
      - name: 开始 Clang 编译
        run: |
          cd kernel-source
          # 下载 AOSP 预编译 Clang (针对 6.6 内核推荐 r522817)
          wget https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86/+archive/refs/heads/main/clang-r522817.tar.gz
          mkdir clang && tar -C clang/ -zxvf clang-r522817.tar.gz > /dev/null
          
          export PATH=$GITHUB_WORKSPACE/kernel-source/clang/bin:$PATH
          make -j$(nproc) ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LLVM=1 LLVM_IAS=1 \
            gki_defconfig
            
          make -j$(nproc) ARCH=arm64 CC=clang \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            CROSS_COMPILE=aarch64-linux-gnu- \
            LLVM=1 LLVM_IAS=1 \
            Image.gz

      - name: 上传成果
        uses: actions/upload-artifact@v4
        with:
          name: OnePlus-MT6991-Fengchi-Hybrid
          path: kernel-source/arch/arm64/boot/Image.gz
