<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Stealth Pro Manager</title>
    <style>
        :root { --bg: #f5f5f7; --card: #ffffff; --accent: #007aff; --danger: #ff3b30; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #1d1d1f; }
        .card { background: var(--card); border-radius: 18px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { margin-top: 0; font-weight: 600; font-size: 20px; }
        .app-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #eee; }
        .app-info { flex: 1; }
        .pkg-name { font-size: 12px; color: #8e8e93; }
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e9e9eb; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(20px); }
        .btn-save { background: var(--accent); color: white; border: none; padding: 16px; width: 100%; border-radius: 14px; font-size: 17px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <h2>隐藏名单</h2>
        <div id="status" style="color: #8e8e93; font-size: 13px; margin-bottom: 10px;">读取中...</div>
        <div id="appList"></div>
    </div>
    <button class="btn-save" onclick="save()">保存更改</button>

    <script>
        const CONF = "/data/adb/modules/stealth_hide/denylist.conf";
        let selectedApps = new Set();

        async function init() {
            try {
                const res = await window.ksu.exec("pm list packages -3 | cut -d: -f2");
                const apps = res.stdout.trim().split('\n').sort();
                const current = (await window.ksu.exec(`cat ${CONF}`)).stdout.trim().split('\n');
                current.forEach(pkg => pkg && selectedApps.add(pkg));

                document.getElementById('appList').innerHTML = apps.map(pkg => `
                    <div class="app-item">
                        <div class="app-info"><div>${pkg.split('.').pop()}</div><div class="pkg-name">${pkg}</div></div>
                        <label class="switch">
                            <input type="checkbox" onchange="toggle('${pkg}')" ${selectedApps.has(pkg)?'checked':''}>
                            <span class="slider"></span>
                        </label>
                    </div>
                `).join('');
                document.getElementById('status').innerText = `共检测到 ${apps.length} 个第三方应用`;
            } catch (e) {
                document.getElementById('status').innerText = "初始化失败: 请确保在 APatch 管理器内运行";
            }
        }

        function toggle(pkg) { selectedApps.has(pkg) ? selectedApps.delete(pkg) : selectedApps.add(pkg); }

        async function save() {
            const data = Array.from(selectedApps).join('\\n');
            await window.ksu.exec(`echo -e "${data}" > ${CONF}`);
            alert("配置已成功下发至内核空间");
        }
        init();
    </script>
</body>
</html>
