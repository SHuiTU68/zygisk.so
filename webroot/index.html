<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Deceiver Ultra V13.5</title>
    <style>
        :root { --accent: #ff3b30; --bg: #000; --card: #1c1c1e; --text: #fff; --sub: #8e8e93; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; overflow: hidden; }
        .app-shell { display: flex; flex-direction: column; height: 100vh; }
        .header { padding: 50px 20px 10px; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); border-bottom: 0.5px solid #333; }
        .header h1 { font-size: 24px; margin: 0; }
        .search-area { padding: 10px 15px; }
        .search-input { width: 100%; background: #1c1c1e; border: 1px solid #333; padding: 12px; border-radius: 12px; color: #fff; }
        .content { flex: 1; overflow-y: auto; padding: 10px 15px 180px; }
        
        /* 应用卡片样式 */
        .app-card { background: var(--card); border-radius: 16px; padding: 14px; margin-bottom: 10px; display: flex; align-items: center; }
        .app-info { flex: 1; margin-left: 12px; }
        .app-name { font-size: 15px; font-weight: 600; }
        .app-pkg { font-size: 11px; color: var(--sub); }

        /* 核心布局：同步按钮固定在导航栏上方 */
        .action-container { position: fixed; bottom: 75px; left: 0; right: 0; padding: 15px 20px; background: linear-gradient(to top, #000 80%, transparent); z-index: 100; }
        .btn-main { background: var(--accent); color: #fff; width: 100%; padding: 18px; border-radius: 16px; border: none; font-weight: 800; font-size: 16px; box-shadow: 0 4px 15px rgba(255,59,48,0.3); }

        /* 底部导航栏 */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 75px; background: #121212; border-top: 0.5px solid #333; display: flex; justify-content: space-around; padding-bottom: 20px; box-sizing: border-box; }
        .nav-item { color: var(--sub); font-size: 10px; text-align: center; padding-top: 10px; }
        .nav-item.active { color: var(--accent); }

        /* 侧滑编辑页 */
        .editor-page { position: fixed; top: 0; right: -100%; width: 100%; height: 100%; background: #000; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 200; display: flex; flex-direction: column; }
        .editor-page.active { right: 0; }
        .editor-header { padding: 50px 20px 15px; border-bottom: 0.5px solid #333; display: flex; align-items: center; }
        textarea { flex: 1; width: calc(100% - 40px); margin: 20px; background: #080808; color: #32d74b; border: 1px solid #333; border-radius: 12px; padding: 15px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="app-shell">
        <div class="header"><h1>控制中心</h1></div>
        <div class="search-area"><input type="text" class="search-input" id="search" placeholder="搜索已安装的应用..." oninput="render()"></div>
        <div class="content" id="list">正在同步数据库...</div>
    </div>

    <div class="action-container">
        <button class="btn-main" onclick="syncAll()">应用并同步内核配置</button>
    </div>

    <div class="nav-bar">
        <div class="nav-item active"><span>◈</span><div>列表</div></div>
        <div class="nav-item"><span>⚙</span><div>设置</div></div>
        <div class="nav-item"><span>ⓘ</span><div>关于</div></div>
    </div>

    <div id="editor-page" class="editor-page">
        <div class="editor-header">
            <span onclick="closeEditor()" style="color:var(--accent); cursor:pointer;">‹ 返回</span>
            <div id="edit-title" style="flex:1; text-align:center; font-weight:bold;">配置</div>
        </div>
        <textarea id="editor-box" spellcheck="false"></textarea>
        <div style="padding:20px;"><button class="btn-main" onclick="saveConfig()">保存策略</button></div>
    </div>

    <script>
        let allApps = [], selectedApps = new Set(), currentPkg = "";
        async function run(c) { try { return await (window.folk || window.ksu).exec(c); } catch(e) { return {stdout:""}; } }

        async function init() {
            try {
                // 核心突破：直接读取由 service.sh 生成的应用列表
                const res = await fetch('app_list.json');
                const data = await res.json();
                allApps = data.map(i => i.pkg);
            } catch(e) {
                const res = await run("ls /data/data | grep '\\.'");
                allApps = res.stdout.trim().split('\n');
            }
            const saved = (await run("cat /data/adb/modules/stealth_hide/denylist.conf")).stdout.trim().split('\n');
            saved.forEach(p => p && selectedApps.add(p.trim()));
            render();
        }

        function render() {
            const key = document.getElementById('search').value.toLowerCase();
            document.getElementById('list').innerHTML = allApps.filter(p => p.includes(key)).map(p => `
                <div class="app-card" onclick="openEditor('${p}')">
                    <div class="app-info"><div class="app-name">${p.split('.').pop()}</div><div class="app-pkg">${p}</div></div>
                    <input type="checkbox" style="width:20px;height:20px;" ${selectedApps.has(p)?'checked':''} onclick="event.stopPropagation(); toggle('${p}')">
                </div>
            `).join('');
        }

        function toggle(p) { selectedApps.has(p) ? selectedApps.delete(p) : selectedApps.add(p); }

        async function openEditor(p) {
            currentPkg = p;
            document.getElementById('edit-title').innerText = p.split('.').pop();
            const res = await run(`cat /data/adb/modules/stealth_hide/configs/${p}.json`);
            document.getElementById('editor-box').value = res.stdout.trim() || '{"susfs": true, "nohello": true}';
            document.getElementById('editor-page').classList.add('active');
        }

        function closeEditor() { document.getElementById('editor-page').classList.remove('active'); }

        async function saveConfig() {
            await run(`mkdir -p /data/adb/modules/stealth_hide/configs && echo '${document.getElementById('editor-box').value}' > /data/adb/modules/stealth_hide/configs/${currentPkg}.json`);
            alert("应用策略已锁定");
            closeEditor();
        }

        async function syncAll() {
            await run(`echo -e "${Array.from(selectedApps).join('\\n')}" > /data/adb/modules/stealth_hide/denylist.conf`);
            alert("同步完成！");
        }
        window.onload = init;
    </script>
</body>
</html>
