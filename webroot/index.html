<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Radiance SafeUI</title>
    <style>
        :root { --accent: #ff3b30; --bg: #000; --card: #1c1c1e; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; visibility: visible !important; }
        .page { display: none; padding: 60px 20px 100px; height: 100vh; box-sizing: border-box; }
        .active { display: block; }
        .card { background: var(--card); border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #333; }
        .nav { position: fixed; bottom: 0; width: 100%; height: 70px; background: #111; display: flex; border-top: 1px solid #222; z-index: 999; }
        .nav-item { flex: 1; text-align: center; padding-top: 15px; color: #666; font-size: 12px; }
        .nav-item.active { color: var(--accent); }
        #sync-btn { position: fixed; bottom: 85px; left: 20px; right: 20px; background: var(--accent); color: #fff; padding: 16px; border: none; border-radius: 12px; font-weight: bold; z-index: 1000; }
    </style>
</head>
<body>
    <div id="p1" class="page active">
        <h2>应用控制中心</h2>
        <div id="status" style="font-size: 12px; color: #8e8e93; margin-bottom: 10px;">准备中...</div>
        <div id="list-container"></div>
    </div>

    <div id="p2" class="page">
        <h2>内核路径自定义 (SUSFS)</h2>
        <textarea id="path-input" style="width:100%; height:200px; background:#000; color:#32d74b; border:1px solid #333; padding:10px; border-radius: 8px; font-family: monospace;"></textarea>
    </div>

    <button id="sync-btn" onclick="applyConfig()">同步内核策略</button>

    <div class="nav">
        <div class="nav-item active" onclick="tab(1)">应用</div>
        <div class="nav-item" onclick="tab(2)">路径</div>
    </div>

    <script>
        // 1. 沙盒化全局变量，避免污染宿主环境
        const RadianceUI = {
            apps: [],
            selected: new Set(),
            // 异步执行封装
            exec: async (cmd) => {
                const api = window.folk || window.ksu;
                if (!api) return { stdout: "" };
                try { return await api.exec(cmd); } catch (e) { return { stdout: "" }; }
            }
        };

        function tab(n) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('p' + n).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // 2. 核心初始化逻辑（非阻塞执行）
        async function initSafe() {
            const status = document.getElementById('status');
            const list = document.getElementById('list-container');
            
            status.innerText = "正在读取内核数据库...";
            
            // 读取由 service.sh 预生成的缓存
            const res = await RadianceUI.exec("cat /data/local/tmp/deceiver_apps.json");
            
            if (!res.stdout) {
                status.innerText = "⚠️ 缓存未就绪，请先点下方同步并重启";
                return;
            }

            try {
                RadianceUI.apps = JSON.parse(res.stdout).map(a => a.pkg);
                const conf = await RadianceUI.exec("cat /data/adb/modules/stealth_hide/denylist.conf");
                conf.stdout.split('\n').forEach(p => p.trim() && RadianceUI.selected.add(p.trim()));
                
                status.innerText = `已加载 ${RadianceUI.apps.length} 个应用`;
                list.innerHTML = RadianceUI.apps.map(p => `
                    <div class="card" style="display:flex; align-items:center;">
                        <div style="flex:1; font-size:14px;">${p}</div>
                        <input type="checkbox" style="width:22px; height:22px;" ${RadianceUI.selected.has(p)?'checked':''} onclick="toggleApp('${p}')">
                    </div>
                `).join('');
            } catch (e) {
                status.innerText = "❌ 数据库解析失败";
            }
        }

        function toggleApp(p) {
            RadianceUI.selected.has(p) ? RadianceUI.selected.delete(p) : RadianceUI.selected.add(p);
        }

        async function applyConfig() {
            const data = Array.from(RadianceUI.selected).join('\\n');
            const paths = document.getElementById('path-input').value;
            await RadianceUI.exec(`echo -e "${data}" > /data/adb/modules/stealth_hide/denylist.conf`);
            await RadianceUI.exec(`echo "${paths}" > /data/adb/modules/stealth_hide/custom_paths.conf`);
            alert("同步成功，配置已下发至内核空间");
        }

        // 3. 延迟启动，确保 WebView 环境完全加载，防止干扰其他 WebUI
        setTimeout(initSafe, 300);
    </script>
</body>
</html>
